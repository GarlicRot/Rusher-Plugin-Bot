name: Update Changelog

on:
  push:
    branches:
      - main

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Extract last changelog commit hash
        id: last_logged
        run: |
          if [[ -f CHANGELOG.md ]]; then
            LAST_HASH=$(grep -oP '(?<=\(\`\)[a-f0-9]{7})[a-f0-9]{7,}' CHANGELOG.md | head -n 1)
          else
            LAST_HASH=""
          fi
          echo "hash=$LAST_HASH" >> $GITHUB_OUTPUT

      - name: Get commits since last changelog entry
        id: commit_list
        run: |
          HASH="${{ steps.last_logged.outputs.hash }}"
          if [[ -z "$HASH" ]]; then
            GIT_LOG_RANGE=""
          else
            GIT_LOG_RANGE="$HASH..HEAD"
          fi

          git log $GIT_LOG_RANGE --pretty=format:"%H|%ad|%s|%an" --date=format:'%Y-%m-%d' > commit_log.txt

          echo "found_commits=$(wc -l < commit_log.txt)" >> $GITHUB_OUTPUT

      - name: Append new commits to CHANGELOG.md
        if: steps.commit_list.outputs.found_commits != '0'
        run: |
          declare -A DATES=()
          while IFS='|' read -r HASH DATE MSG AUTHOR; do
            SHORT_HASH=${HASH:0:7}
            ENTRY="- \`${MSG}\` ([\`${SHORT_HASH}\`](https://github.com/${{ github.repository }}/commit/${HASH})) by **${AUTHOR}**"
            DATES["$DATE"]+="${ENTRY}\n"
          done < commit_log.txt

          for DATE in "${!DATES[@]}"; do
            if grep -q "### $DATE" CHANGELOG.md 2>/dev/null; then
              sed -i "/### $DATE/a ${DATES[$DATE]}" CHANGELOG.md
            else
              echo -e "\n---\n\n### $DATE\n${DATES[$DATE]}" >> CHANGELOG.md
            fi
          done

      - name: Commit and push changelog
        if: steps.commit_list.outputs.found_commits != '0'
        run: |
          git add CHANGELOG.md
          git commit -m "docs(changelog): update with new commits"
          git push
